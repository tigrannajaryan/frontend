os: osx
osx_image: xcode9.4

language: node_js
node_js:
  - "8.11.1"
conditions: v1

notifications:
  slack:
# madebeauty:secret_token
    secure: vJbc7xWQeNMcIli5cm7kTivKb3usejMW3tpqjG/Y5Mi4h/GBC4zV/TdUUZgLUIDhsRfTu7iODovs4Faw7/Rj8dul/EM6/1DGYvDc2J737T0hTI+GxnWjgp8DfaZ9EGuv/tuRj8/BM8grJt+py4bvD+YBsxUN/mcmnMORnN1zIxtu6MZJH3VejiGmjde0lM1YilI8NP1kOM7JE3d7+1tQ2zTiK4nyJ7cnjhpTJs6T7rQEtwxOshEnkKryMwdNeqc2OPAttx/lPEhG9F6N6z3WETW6iqKsvv5/UebrneL+xXgKEc0ayCjUFtP/HwIiHElOIPutA9hCuWb+RFAxbZMHx6HrmZn+BeyWOAsx/369eCwwpIxTTtLcX6CmmXGR8aqF5bi56pcJOVt1LKHk89iD3SqHW0OZLuz6o2vjPnhhvWAHu+UH4cdPHjlVf7ohe3/Y9NSqo+UpfFGKrTqT8pQi73lgm/uV7YQEjrVpZ5k9bg7ey0oBgjYnhClTpGjJzGvmm4AH9UowU57M5w9rnwVxRCi3CiHjbfHDWkqKb3/bxEUx9QwTOpw+Y+Hux5tyZw8njhn5inFhy3du6fe7XHnTK4N20fupBBeC0sx7KPoN4oNSF+gq2sM1/Af6gXbPSU3mej9NIsgMD1cYqsL7brQhtsfqSLXQRW5uImb/zPmJq1k=

# Only run on develop branch and on pull requests against develop
branches:
  only:
    - develop

# Chrome is needed for E2E Protractor tests
addons:
  chrome: beta

# cache packages after each build, and restore on next builds
# if a change is detected after build finishes - update cache

before_cache:
  - rm -rf $HOME/.gradle/caches/*/plugin-resolution/ || true
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock || true

cache:
  directories:
    - mobile/stylist/node_modules
    - mobile/client/node_modules
    - $HOME/.gradle/caches/
    - $HOME/.gradle/wrapper/

# global env variables, common to each build's environment
env:
  global:
    - APP_VERSION_NUMBER=1.1.6
    - IOS_SDK="iphoneos11.4"
    - ANDROID_SDK=android_sdk
    - ANDROID_BUILD_TOOLS_VERSION="28.0.1"
    - ANDROID_HOME="$TRAVIS_BUILD_DIR/$ANDROID_SDK"
    - JAVA_HOME="/Library/Java/JavaVirtualMachines/jdk1.8.0_181.jdk/Contents/Home"
    - >-
        IOS_CODE_SIGN_IDENTITY="iPhone Distribution: BetterBeauty, Inc"
    - SENTRY_ORGANIZATION="madebeauty"
    - SENTRY_SKIP_AUTO_RELEASE=true
    # expands to IOS_DISTRIBUTION_CERT_PASSWORD=password
    - secure: "VUCYLUkexxWrobNg6Gt8PNiU4FXkcyPlO2xn/WfBelFr4TQszihUwfs54NHu10QS2Km5mq3o2g5MX1J6W7GJOs4AgqFTOKzCDOEoKS56meOXA17aFDkg3+O2nwUJPwYJjH8yaNBa7K0pTYIwFmUqa53Kd6TAWPT1iySxvRReZGbWVVyAEAw3jzin0xWKdarxE/dUvoSaAoWwo6MOGYUdE1fbJ5/v1ZD0yynckx3405va9uGeukgoMw+IZ/anqdeodUMJwFCxXhQkwr/8umudKHz4VNnpsfawrH7xBEKJCqZw+H825wZBoYa2rpMRnRbTd6tAxX2t2tDE5qHg/7kzYmvvOw6N1Z+NbxFA4Z3LefFXCeI6YHpawuNv+EYd7bdZea3PTJG53nAjBEdExJN/rIZMekQQ2Hb4SGaL9Nhs+vyxZwXJbdQjgpbNEGBBJZZPCLl9GrqebV3Q9Yfhmes9L7UY2ePpAwzYcF1v9yzfni1nB1MssKDa2vcR1+jIJt2wnI5uPheGdz+jDgokvdqNdusLHqDIFC5zjouI/x+h3Jyhnqic8kenRHNHeW0MQOUZmf+l0SXeeGFSn8TEr5FqBU4k4bQJqxFgYDflASHtlZ5U0HOt9oZtP57dAZ5/k36U5V0aO3EzmZ7lZudzQLdP+WVMVGBRi2TKumaMoMSa058="
    # $FASTLANE_USER; expands to FASTLANE_USER=itunes_email
    - secure: "VBwq9qe5azRyd3GgtgagdpxrpVk4LQLLSI4vJifhd1SSC7ZvonK9/ouK+AjoXROuFgwk6y4Nbqv4mksCP41Cfy1BrySjumxtAlDCJ8ceV/Pt9bHSvamNaUmBs+gVu6LOBQq1Dw0coZOiMC9OdT0s6ysYZjK7CfFCrxplYpKY7Q0JJBObkFiQLVGWSu1mjPlDbHEeGzo1vYjbcuI1OroOBxwbqqr4gQOylzXCW3JKxX9ZlaqjmhGuIbECWhN9x615CC+mvkCsFq3xbrq4PY/+AZHc2PPT8oA43+Te/AJkC4+iLQBthvqeXz76uLcqrSQG63N4TRBdIJQj+KaRWarIsxTO9Cblok17LdGvSM3+8hQR83RNSsv13Ck3DV8g+dBp/FNiR3HN/aDLHHXD7g1g6Ly7hU/8nhXPBIMUSJ/lga4Von+jfysDnLtUqJqF59DOGR1pT7mVGt7gV80um7LQP2T7+gnpKHbnhpdcja8D/LYntsSyS9WRgcHTPI/CBVLk3XiIELl9rxbmibjdV0gPigX00+2zLU/t3jR4nMUy8GZvcRbX9ueRPSrxwtXCYFLwfYhMUF8TZ9Mztw+1kRF1wcqWjXMYGCcbcOSz3qWIoLCJOGRvx+bgnboCrmBau3mhiQrcvh9MY8EW941aPUlLznWqMoHqfWZlKXCTkIIyuSI="
    # $FASTLANE_PASSWORD; expands to FASTLANE_PASSWORD=password
    - secure: "s3VJowr8313rTyyeCzSW5qbUUivpysa7UrVwksEngqA8RuqkcxmTqUJNsK+zO/fNvdTQ8Lky/rGq/snf0LX62ekBPUT9QgDv0D/fNwNxc7MVt4lTpw0NdtoXlCsATpj1zOcozpkq84GoQlFHew9CLZxddHawN7od0jCop99C6qjDsqtDymJqGvCeJdu6ICJXz7SAoEZeuNUal4lL3LnxsOGfi20dNJKg4Rf2tYMSH/ygbPO8LvqNpXSw+XLveO71n3Jk6djbifNPZPOvwo5g09BPOMkbnxyeGKSqbF8zk8wXlDHv8OAX2CukjVrYqTk10WC5+a3vt9BJaIXtYuZ/6pOBH44RYTMIqI9hFP33H3jBlUDXb/AFujG0u/l1sLKpoyCU0MiwYB+dXZc/FTuiEfsVCCf1cAypjIRvbJVC5GQxlCB0/JVGIGGbdcNiqmmkPEFyg0SmWgmxPnhT+pM/LvHGehsYtRMRvNFsKHGFRBreAxI+MdfePZ4QQabS7QGh5YXB2lMKgKIL45hwHhWaorovQ+yDUnqxm0pGnsW4Y2RZtlWV4nJXbzfygKgSJhC3OxClPNc3NE3yUpWDE7mvTeLIGziyRwI0RhL/vdXhuq+XRnF0lmQj2yPHOEI1psd1+afs6NpV4rgJDHZ4xsiblN01riuktKQKHvENByCqyFs="
    # $SENTRY_AUTH_TOKEN; expands to SENTRY_AUTH_TOKEN=token
    - secure: "M58uRd5J8WXlKyupoNTJUovF2cZxV6CRKl15V9i8oobBiqkd5dgh8bfreuLtKh+lOlxJ6vHUzaWJpgHfgdd1LxIBgbyAK+5FJFC1KeuyRwIJCSAD4MMi0BsJeWXPCpPnDT6lUypoFE3VNE9HPYkqouJCorTAlSL6P/6w2Iv9YZOAkJMeqwmM8EvayNYx0rr/0/1DrHIbn+klRzDSf6lCXpqlnN88vNSnu9RsI8oDmr7RsDr/kK2+I8B9uKPR//O+HzbIo7Jhx0j2kiXmHcNmUFXGHirOAn6dRhqpR0J4w1dZENYojlBGk5KICyJ9+nFl75vDy0po/Q3llVuEjkURQv3zuHKB+Hhe5R13qsCoK0bxAS+42CA1HxYPckodcViUMnBDwMf4irhw12CQScr91no+YCrO0yNgUMoKLV/WC7AaIq8pqfW/eow6ZmSuCBla1ZzyRzIYJqbGTOwKMgGYcfB4l2SNWHFssJOu2BZbyaqK4FBTeLM5Ux4dS85tCpV5crvz79nRsPUshxRGTGrHy/Hlb1tMGQOTA5JXL7sO9N3FwsjJfvLNxa5W99zTLAGwPrtC4v+Q9hpie6P78nYB5PIjWTV8BJ2MYk9q0CJDctGYh3A+kWAhFwGoWdLsCs9Qjnp0HIzct/lInujIxeKTKkmEWrAUf/IBj0eS5gZPfSg="

jobs:
  fast_finish: true
  include:
    - name: Client Staging Build
      env:
        APP_TYPE=client
        MB_ENV=staging
        IOS_APP_BUNDLE_ID="com.madebeauty.client.staging"
        ANDROID_APP_BUNDLE_ID="com.madebeauty.client.staging.android"
        IOS_APP_NAME="MadeBeauty Staging"
        IOS_APP_DESCRIPTION="MadeBeauty Staging"
        IOS_PROVISIONING_PROFILE="client-staging"
        IOS_PROVISIONING_PROFILE_ID="b76338ed-b7e9-4053-ab42-ec80d7eea4ba"
        FASTLANE_SKIP_WAITING=true
        FASTLANE_DISTRIBUTE_EXTERNAL=false
        SENTRY_PROJECT=mobile-client-staging
    - name: Stylist Staging Build
      env:
        APP_TYPE=stylist
        MB_ENV=staging
        IOS_APP_BUNDLE_ID="com.madebeauty.stylist.beta"
        IOS_APP_NAME="Made Pro Staging"
        IOS_APP_DESCRIPTION="Fill up your days. Earn more."
        IOS_PROVISIONING_PROFILE="made-final-appstore"
        IOS_PROVISIONING_PROFILE_ID="b36b0583-9122-4176-becf-38d769edee4d"
        FASTLANE_SKIP_WAITING=true
        FASTLANE_DISTRIBUTE_EXTERNAL=false
        SENTRY_PROJECT=mobile-stylist-staging
    - name: Client Production Build
      if: branch = develop AND type = push  # run this stage only if it's not a PR
      env:
        APP_TYPE=client
        MB_ENV=prod
        IOS_APP_BUNDLE_ID="com.madebeauty.client.production"
        ANDROID_APP_BUNDLE_ID="com.madebeauty.client.prod"
        IOS_APP_NAME="MadeBeauty"
        IOS_APP_DESCRIPTION="MadeBeauty"
        IOS_PROVISIONING_PROFILE="client-production"
        IOS_PROVISIONING_PROFILE_ID="222754f3-76d8-4094-9da5-78e105d5f541"
        FASTLANE_SKIP_WAITING=true
        FASTLANE_DISTRIBUTE_EXTERNAL=false
        SENTRY_PROJECT=mobile-client-production
    - name: Stylist Production Build
      if: branch = develop AND type = push  # run this stage only if it's not a PR
      env:
        APP_TYPE=stylist
        MB_ENV=prod
        IOS_APP_BUNDLE_ID="com.madebeauty.stylist.production"
        IOS_APP_NAME="Made Pro"
        IOS_APP_DESCRIPTION="Fill up your days. Earn more."
        IOS_PROVISIONING_PROFILE="made-final-appstore"
        IOS_PROVISIONING_PROFILE_ID="b36b0583-9122-4176-becf-38d769edee4d"
        FASTLANE_SKIP_WAITING=true
        FASTLANE_DISTRIBUTE_EXTERNAL=false
        SENTRY_PROJECT=mobile-stylist-production

# run basic node / angular build and test
install: mobile/scripts/should-skip-build.sh || mobile/scripts/travis_install.sh

# prepare and build iOS app
script: mobile/scripts/should-skip-build.sh || mobile/scripts/travis_script.sh

before_deploy:
  # install fastlane - a tool which allows uploads to appStoreConnect
  # upload procedure uses proprietary Apple's protocol; fastlane is a
  # wide-known solution for handling this procedure
  - mobile/scripts/should-skip-build.sh || gem install fastlane --no-ri --no-rdoc --no-document

deploy:
  skip_cleanup: true
  # run deploy only if this is a merge to develop (e.g. branch is
  # `develop` and it's not a pull request validation build). Travis would set
  # `branch` variable to `develop` also in case if it's a PR build agains `develop`
  # branch, so we need an extra check against commit type
  on:
    branch: develop
    condition: $TRAVIS_PULL_REQUEST = false
  provider: script # indicates we'll run a bash script here
  # actually upload resulting Android and iOS app to Google.Play and appStoreConnect using fastlane
  script: mobile/scripts/should-skip-build.sh || mobile/scripts/deploy-mobile-apps.sh

after_script:
  # teardown and remove distribution certificate and provisioning profile
  - cd $TRAVIS_BUILD_DIR
  - mobile/scripts/remove-apple-profile.sh
  - mobile/scripts/remove-apple-certificate.sh
  - rm -f mobile/android-cert/*
